---
title: "t_8_21_paired_Dx_Rx"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
date: "`r Sys.time()`"
author: jtrincado
---

## Introduction

Compare the paired Dx-Rx samples

## 1. AML8_Dx-AML8_Rx: Take the LSC clusters we derived independently

```{r part1, echo=FALSE, fig.height=8, fig.width=4, message=FALSE}
library(Seurat) 
library(ggplot2) 
library(ggExtra) 
library(dplyr)
library(data.table)
library(grid)
library(RColorBrewer)
library(forcats) 

Hypoxia_genes <- list(c("ABCB1","ABCG2","ADM","ADRA1B","AK4","ALDOA","ALDOC","ANGPT2","ANKRD37","ANXA1","BHLHE40","BHLHE41","BNIP3","BNIP3L","CA9","CAD","CALCRL","CAPG","CCNG2","CCR7","CD99","CDKN1A","CITED2","COL5A1","CP","CTGF","CTSD","CXCL12","CXCR4","CYP2S1","DDIT4","DEC1","EDN1","EGLN1","EGLN3","ENG","ENO1","EPO","ERO1A","ETS1","FAM162A","FECH","FN1","FURIN","GADD45B","GAPDH","GPI","GPX3","HK1","HK2","HMOX1","HSP90B1","ID2","IGF2","IGFBP1","IGFBP2","IGFBP3","ITGB2","JUNB","KDM3A","KDM4B","KITLG","KRT14","KRT18","KRT19","LDHA","LEP","LGALS1","LOX","LRP1","MCL1","MET","MMP14","MMP2","MMP9","MXI1","NAMPT","NOS2","NOS3","NPM1","NR4A1","NRN1","NT5E","P4HA1","P4HA2","P4HTM","PDGFA","PDK1","PFKFB3","PFKL","PGK1","PKM","PLAUR","PMAIP1","PPP5C","PROK1","RCOR2","S100A4","SENP1","SERPINE1","SLC2A1","SLC2A3","SOX9","STC2","TCF3","TERT","TF","TFF3","TFRC","TGFA","TGFB3","TGM2","TPI1","TWIST1","UCN2","VEGFA","VIM","ZEB1","ZEB2"))

Other_LSC_markers <- list(c("CD93","MIR126","IL3RA","HAVCR2","CD96","CLEC12A","IL2RA","FCGR2A","CD47","HLF","CD33","CD52","CD82","CD99","IL1RAP","CD36","ADGRG1","BCL2","CD200","KLRK1"))

LSC_signature <- list(c("DNMT3B","CD34","ADGRG1","SOCS2","SPINK2","FAM30A"))

#### 1. Load samples processed from AML8_Dx.Rmd and AML8_Rx.Rmd
AML8_Dx$orig.name <- "AML8_Dx"
AML8_Dx$old_clustering <- paste0("AML8_Dx_",Idents(AML8_Dx))
AML8_Dx$Cond <- "Dx"

AML8_Rx$orig.name <- "AML8_Rx"
AML8_Rx$old_clustering <- paste0("AML8_Rx_",Idents(AML8_Rx))
AML8_Rx$Cond <- "Rx"

#### 2.  Integrate the datasets
dt.list <- unlist(list(c(AML8_Dx,AML8_Rx)))
for (i in 1:length(dt.list)) {
    dt.list[[i]] <- NormalizeData(dt.list[[i]], verbose = FALSE)
    dt.list[[i]] <- FindVariableFeatures(dt.list[[i]], selection.method = "vst", nfeatures = 2000, verbose = FALSE)
}
anchors <- FindIntegrationAnchors(object.list = dt.list, dims = 1:30)
integrated.obj1 <- IntegrateData(anchorset = anchors, dims = 1:30)

#### 3. PCA and markers
DefaultAssay(integrated.obj1) <- "integrated"
integrated.obj1 <- ScaleData(integrated.obj1,vars.to.regress = c("nCount_RNA","percent.mito"), features = rownames(integrated.obj1))
integrated.obj1 <- RunPCA(integrated.obj1, features = VariableFeatures(integrated.obj1), npcs = 40)
ElbowPlot(integrated.obj1,ndims = 40)

#Use first 22 PC
n_PC = 22
integrated.obj1 <- FindNeighbors(integrated.obj1, dims = 1:n_PC)

integrated.obj1 <- FindClusters(integrated.obj1, resolution = 0.9)
head(Idents(integrated.obj1), 5)

n_cells = ncol(integrated.obj1)
getPalette = colorRampPalette(brewer.pal(11, "Set1"))
colors = getPalette(length(unique(Idents(integrated.obj1))))

#UMAP
integrated.obj1 <- RunUMAP(integrated.obj1, dims = 1:n_PC)
# Plot
DimPlot(integrated.obj1, reduction = "umap",  pt.size = 1.2) + scale_color_manual(values = colors)
DimPlot(integrated.obj1, reduction = "umap", group.by = "Sample_id", pt.size = 1.2 ) 
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "Phase") 
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "orig.name") 
plot1 <- DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "Cond") + scale_color_manual(values =c("#82bbbf", "#fc03be")) + NoAxes()
plot1
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "old_clustering", label = TRUE) + NoLegend()
integrated.obj1$prediction <- factor(integrated.obj1$prediction,levels=c("HSC","Prog","GMP","ProMono","Mono","cDC","pDC","earlyEry","lateEry","ProB","B","Plasma","T","CTL","NK"))
getPalette = colorRampPalette(brewer.pal(12, "Paired"))
colors2 = getPalette(15)
plot2 <- DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "prediction", label = TRUE) +  scale_color_manual(values = colors2)
plot2
colorsVelten <- readRDS(file="~/predictions_Velten_colorpalette.rds")
integrated.obj1$celltype[which(integrated.obj1$celltype=="Lymphoid-primed")] <- "LMPPs"
integrated.obj1$celltype[which(integrated.obj1$celltype=="Mast")] <- "Eosinophil-basophil-mast prog"
plot3 <- DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "celltype", label = TRUE) +  scale_color_manual(values = colorsVelten)
plot3
#Color the LSC clusters from Dx/Rx
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "celltype", label = TRUE)

#Get all markers, without logFC filter
all_markers_LSC_AML8 <- FindMarkers(integrated.obj1, ident.1 = "AML8_Dx_3", ident.2 = "AML8_Rx_8", only.pos = FALSE, logfc.threshold = 0)
all_markers_LSC_AML8$cluster <- unlist(lapply(all_markers_LSC_AML8$avg_log2FC,function(x)ifelse(x>0,"AML8_Dx_3","AML8_Rx_8")))
all_markers_LSC_AML8$avg_log2FC <- abs(all_markers_LSC_AML8$avg_log2FC)
all_markers_LSC_AML8$gene <- rownames(all_markers_LSC_AML8)
table(all_markers_LSC_AML8[which(all_markers_LSC_AML8$avg_log2FC>=0.25),]$cluster)

```

### 1.1 Check the differences between Dx/Rx on the LSC6 and Hypoxia

```{r part1.1, echo=FALSE, fig.height=5, fig.width=5, message=FALSE}
library(ggpubr)

aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Elsayed_LSC_score_integrated=integrated.obj1$Elsayed_LSC_score_integrated,Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id,Hypoxia=range01(integrated.obj1$Hypoxia_genes1))
aux_df1$log.Elsayed_LSC_score_integrated <- log(range01(aux_df1$Elsayed_LSC_score_integrated)+0.01)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
aux_df1$LSC_status2 <- "Xx_LSC 34+"
aux_df1$LSC_status2[which(aux_df1$LSC_status=="LSC 34+" & aux_df1$Condition=="Dx")] <- "Dx_LSC 34+"
aux_df1$LSC_status2[which(aux_df1$LSC_status=="LSC 34+" & aux_df1$Condition=="Rx")] <- "Rx_LSC 34+"

plot2 <- ggplot(aux_df1,aes(x=LSC_status,y=log.Elsayed_LSC_score_integrated,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 
plot2
plot3 <- ggplot(aux_df1,aes(x=LSC_status,y=Hypoxia,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 
plot3
#Sort by LSC_status2
aux_df1 <- aux_df1[order(aux_df1$LSC_status2, decreasing=T),]
aux_df1$LSC_status2[which(aux_df1$LSC_status2=="Xx_LSC 34+")] <- NA

plot4 <- ggplot(aux_df1,aes(x=umap1,y=umap2,colour=LSC_status2)) +
  geom_point() +
  theme_void() +
  scale_color_manual(values=c("#5ECECF", "#3070D6"))
plot4

```

### 1.2. Test other signatures and the difference between Dx/Rx

```{r part1.2, echo=FALSE, fig.height=5, fig.width=6, message=FALSE}
library(ggpubr)
library(UCell)
library(xlsx)

#Scale all values from 0 to 1
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
DefaultAssay(integrated.obj1) <- "RNA"

#Create an extra variable to differentiate between the LSC groups on Dx/Rx
LSC_status <- rep("NonLSC 38+",ncol(integrated.obj1))
LSC_status[which(integrated.obj1$Sample_id=="CD34")] <- "NonLSC 34+"
LSC_status[which(integrated.obj1$old_clustering=="AML8_Dx_3" | integrated.obj1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
LSC_status <- factor(LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
names(LSC_status) <- colnames(integrated.obj1)
integrated.obj1 <- AddMetaData(object = integrated.obj1, metadata = LSC_status, col.name = "LSC_status")

#Get only the genes expressed comarping also against the rest of cells
Idents(integrated.obj1) <- paste0(integrated.obj1$LSC_status,"_",integrated.obj1$Cond)
integrated.obj1 <- AddMetaData(object = integrated.obj1, metadata = Idents(integrated.obj1), col.name = "Group2")
integrated.obj1$Group2 <- factor(integrated.obj1$Group2, levels=c("LSC 34+_Dx","LSC 34+_Rx","NonLSC 34+_Dx","NonLSC 34+_Rx","NonLSC 38+_Dx","NonLSC 38+_Rx"))

#### 1. Hallmark glycolisis (Msigdb) ####
hallmark_glycolisis <- list(c("ABCB6","ADORA2B","AGL","AGRN","AK3","AK4","AKR1A1","ALDH7A1","ALDH9A1","ALDOA","ALDOB","ALG1","ANG","ANGPTL4","ANKZF1","ARPP19","ARTN","AURKA","B3GALT6","B3GAT1","B3GAT3","B3GNT3","B4GALT1","B4GALT2","B4GALT4","B4GALT7","BIK","BPNT1","CACNA1H","CAPN5","CASP6","CD44","CDK1","CENPA","CHPF","CHPF2","CHST1","CHST12","CHST2","CHST4","CHST6","CITED2","CLDN3","CLDN9","CLN6","COG2","COL5A1","COPB2","CTH","CXCR4","CYB5A","DCN","DDIT4","DEPDC1","DLD","DPYSL4","DSC2","ECD","EFNA3","EGFR","EGLN3","ELF3","ENO1","ENO2","ERO1A","EXT1","EXT2","FAM162A","FBP2","FKBP4","FUT8","G6PD","GAL3ST1","GALE","GALK1","GALK2","GAPDHS","GCLC","GFPT1","GLCE","GLRX","GMPPA","GMPPB","GNE","GNPDA1","GOT1","GOT2","GPC1","GPC3","GPC4","GPR87","GUSB","GYS1","GYS2","HAX1","HDLBP","HK2","HMMR","HOMER1","HS2ST1","HS6ST2","HSPA5","IDH1","IDUA","IER3","IGFBP3","IL13RA1","IRS2","ISG20","KDELR3","KIF20A","KIF2A","LCT","LDHA","LDHC","LHPP","LHX9","MDH1","MDH2","ME1","ME2","MED24","MERTK","MET","MIF","MIOX","MPI","MXI1","NANP","NASP","NDST3","NDUFV3","NOL3","NSDHL","NT5E","P4HA1","P4HA2","PAM","PAXIP1","PC","PDK3","PFKFB1","PFKP","PGAM1","PGAM2","PGK1","PGLS","PGM2","PHKA2","PKM","PKP2","PLOD1","PLOD2","PMM2","POLR3K","PPFIA4","PPIA","PPP2CB","PRPS1","PSMC4","PYGB","PYGL","QSOX1","RARS1","RBCK1","RPE","RRAGD","SAP30","SDC1","SDC2","SDC3","SDHC","SLC16A3","SLC25A10","SLC25A13","SLC35A3","SLC37A4","SOD1","SOX9","SPAG4","SRD5A3","STC1","STC2","STMN1","TALDO1","TFF3","TGFA","TGFBI","TKTL1","TPBG","TPI1","TPST1","TSTA3","TXN","UGP2","VCAN","VEGFA","VLDLR","XYLT2","ZNF292"))
names(hallmark_glycolisis) <- "hallmark_glycolisis"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = hallmark_glycolisis, name="hallmark_glycolisis")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),hallmark_glycolisis=range01(integrated.obj1$hallmark_glycolisis1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=hallmark_glycolisis,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 2. Hallmark Ox phosphorilation (MsigDB) ####
hallmark_ox_phosphorylation <- list(c("ABCB7","ACAA1","ACAA2","ACADM","ACADSB","ACADVL","ACAT1","ACO2","AFG3L2","AIFM1","ALAS1","ALDH6A1","ATP1B1","ATP5F1A","ATP5F1B","ATP5F1C","ATP5F1D","ATP5F1E","ATP5MC1","ATP5MC2","ATP5MC3","ATP5ME","ATP5MF","ATP5MG","ATP5PB","ATP5PD","ATP5PF","ATP5PO","ATP6AP1","ATP6V0B","ATP6V0C","ATP6V0E1","ATP6V1C1","ATP6V1D","ATP6V1E1","ATP6V1F","ATP6V1G1","ATP6V1H","BAX","BCKDHA","BDH2","CASP7","COX10","COX11","COX15","COX17","COX4I1","COX5A","COX5B","COX6A1","COX6B1","COX6C","COX7A2","COX7A2L","COX7B","COX7C","COX8A","CPT1A","CS","CYB5A","CYB5R3","CYC1","CYCS","DECR1","DLAT","DLD","DLST","ECH1","ECHS1","ECI1","ETFA","ETFB","ETFDH","FDX1","FH","FXN","GLUD1","GOT2","GPI","GPX4","GRPEL1","HADHA","HADHB","HCCS","HSD17B10","HSPA9","HTRA2","IDH1","IDH2","IDH3A","IDH3B","IDH3G","IMMT","ISCA1","ISCU","LDHA","LDHB","LRPPRC","MAOB","MDH1","MDH2","MFN2","MGST3","MPC1","MRPL11","MRPL15","MRPL34","MRPL35","MRPS11","MRPS12","MRPS15","MRPS22","MRPS30","MTRF1","MTRR","MTX2","NDUFA1","NDUFA2","NDUFA3","NDUFA4","NDUFA5","NDUFA6","NDUFA7","NDUFA8","NDUFA9","NDUFAB1","NDUFB1","NDUFB2","NDUFB3","NDUFB4","NDUFB5","NDUFB6","NDUFB7","NDUFB8","NDUFC1","NDUFC2","NDUFS1","NDUFS2","NDUFS3","NDUFS4","NDUFS6","NDUFS7","NDUFS8","NDUFV1","NDUFV2","NNT","NQO2","OAT","OGDH","OPA1","OXA1L","PDHA1","PDHB","PDHX","PDK4","PDP1","PHB2","PHYH","PMPCA","POLR2F","POR","PRDX3","RETSAT","RHOT1","RHOT2","SDHA","SDHB","SDHC","SDHD","SLC25A11","SLC25A12","SLC25A20","SLC25A3","SLC25A4","SLC25A5","SLC25A6","SUCLA2","SUCLG1","SUPV3L1","SURF1","TCIRG1","TIMM10","TIMM13","TIMM17A","TIMM50","TIMM8B","TIMM9","TOMM22","TOMM70","UQCR10","UQCR11","UQCRB","UQCRC1","UQCRC2","UQCRFS1","UQCRH","UQCRQ","VDAC1","VDAC2","VDAC3"))
names(hallmark_ox_phosphorylation) <- "hallmark_ox_phosphorylation"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = hallmark_ox_phosphorylation, name="hallmark_ox_phosphorylation")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),hallmark_ox_phosphorylation=range01(integrated.obj1$hallmark_ox_phosphorylation1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=hallmark_ox_phosphorylation,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 3. lysosome ####
lysosome <- list(c("TCIRG1","ATP6V0A2","ATP6V0A4","ATP6V0A1","ATP6V0D1","ATP6V1H","ATP6AP1","ATP6V0C","ATP6V0B","CTSA","CTSB","CTSC","CTSD","CTSE","CTSF","CTSG","CTSH","CTSK","CTSL","CTSO","CTSS","CTSV","CTSW","CTSZ","NAPSA","LGMA","TPP1","GLA","GLB1","GAA","GBA","IDUA","NAGA","NAGLU","GALC","GUSB","FUCA1","FUCA2","HEXA","HEXB","MANBA","MAN2B1","NEU1","HYAL2","HYAL1","SPAM1","HYAL4","HYAL3","ARSA","ARSB","ARSG","GALNS","GNS","IDS","SGSH","LIPA","PLA2G15","DNASE2B","DNASE2","ACP2","ACO5","SMPD1","ASAH1","AGA","PSAP","PSAPL1","GM2A","PPT1","PPT2","LAMP1","LAMP2","LAMP3","CD68","CD63","SCARB2","NPC1","NPC2","CTNS","SLC17A5","SLC11A1","SLC11A2","LAPTM4B","LAPTM5","LAPTM4A","ABCA2","ABCB9","CD164","ENTPD4","SORT1","CLN3","CLN5","MFSD8","HGSNAT","SUMF1","GNPTAB","GNPTG","NAGPA","IGF2R","M6PR","CLT1","CLTB","CLTC","CLTCL1","AP1G1","AP1G2","AP1B1","AP1M1","AP1M2","AP1S1","AP1S2","AP1S3","AP3D1","AP3B2","AP3B1","AP3M1","AP3M2","AP3S2","AP3S1","AP4E1","AP4B1","AP4M1","AP4S1","GGA2","GGA3","GGA1","MCOLN1","LITAF"))
names(lysosome) <- "lysosome"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = lysosome, name="lysosome")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),lysosome=range01(integrated.obj1$lysosome1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=lysosome,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



####4. Negative_G0_to_G1  ####
Negative_G0_to_G1 <- list(c("RBBP7","DAB2IP","MGA","YAF2","RYBP","PHC3","L3MBTL2","EHMT2","RNF2","RBBP8","PCGF6","EPC1","EHMT1","UXT","DUX4","PPP2R5B","CDC7","APAF1","CHEK1","E2F6","EED","HLA-G","RRM2","BMI1","PCGF2","BRCA1","CBX5","MAX","PHC1","FOXO4","E2F1","RING1","RAD51","RBBP4","CBX3","TFDP1","TFDP2","SUZ12","PPP2R5B","EZH2"))
names(Negative_G0_to_G1) <- "Negative_G0_to_G1"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Negative_G0_to_G1, name="Negative_G0_to_G1")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Negative_G0_to_G1=range01(integrated.obj1$Negative_G0_to_G11),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Negative_G0_to_G1,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 5. Translation Initiation ####
translation <- list(c("ABCE1","AGO2","ALKBH1","ATF4","BANK1","BOLL","C8orf88","CCL5","CDC123","COPS5","CTIF","DAZ1","DAZ2","DAZ3","DAZ4","DAZL","DDX1","DDX3X","DENR","DHX29","DHX33","DNAJC3","EIF1","EIF1AD","EIF1AX","EIF1AY","EIF1B","EIF2A","EIF2AK1","EIF2AK2","EIF2AK3","EIF2AK4","EIF2B1","EIF2B2","EIF2B3","EIF2B4","EIF2B5","EIF2D","EIF2S1","EIF2S2","EIF2S3","EIF2S3B","EIF3A","EIF3B","EIF3C","EIF3CL","EIF3D","EIF3E","EIF3F","EIF3G","EIF3H","EIF3I","EIF3J","EIF3K","EIF3L","EIF3M","EIF4A1","EIF4A2","EIF4B","EIF4E","EIF4E1B","EIF4E2","EIF4E3","EIF4EBP1","EIF4EBP2","EIF4EBP3","EIF4G1","EIF4G2","EIF4G3","EIF4H","EIF5","EIF5B","EIF6","FMR1","GLE1","HABP4","HSPB1","IMPACT","KHDRBS1","KLHL25","LARP1","LTO1","MCTS1","METTL3","MIF4GD","MTFMT","MTIF2","MTIF3","MTOR","NCBP1","NCBP2","NCK1","NCK2","NPM1","PABPC1","PAIP1","PAIP2","PAIP2B","POLR2D","POLR2G","PPP1CA","PPP1R15A","PPP1R15B","RBM4","RPL10","RPL10A","RPL11","RPL12","RPL13","RPL13A","RPL14","RPL15","RPL17","RPL18","RPL18A","RPL19","RPL21","RPL22","RPL23","RPL23A","RPL24","RPL26","RPL27","RPL27A","RPL28","RPL29","RPL3","RPL30","RPL31","RPL32","RPL34","RPL35","RPL35A","RPL36","RPL36A","RPL37","RPL37A","RPL38","RPL39","RPL4","RPL41","RPL5","RPL6","RPL7","RPL7A","RPL8","RPL9","RPLP0","RPLP1","RPLP2","RPS10","RPS11","RPS12","RPS13","RPS14","RPS15","RPS15A","RPS16","RPS17","RPS18","RPS19","RPS2","RPS20","RPS21","RPS23","RPS24","RPS25","RPS26","RPS27","RPS27A","RPS28","RPS29","RPS3","RPS3A","RPS4X","RPS4Y1","RPS5","RPS6","RPS6KB1","RPS6KB2","RPS7","RPS8","RPS9","RPSA","RXRA","TNF","TPR","UBA52","UHMK1","YTHDF1","YTHDF2","YTHDF3"))
names(translation) <- "translation"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = translation, name="translation")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),translation=range01(integrated.obj1$translation1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=translation,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 6. G0_Fukushima ####
go_genes <- c("APAF1","BMI1","BRCA1","CBX3","CBX5","CDC7","CHEK1","DAB2IP","DUX4","E2F1","E2F6","EED","EHMT1","EHMT2","EPC1","EZH2","FOXO4","HLA-G","L3MBTL2","MAX","MGA","PCGF2","PCGF6","PHC1","PHC3","PPP2R5B","PPP2R5B","RAD51","RBBP4","RBBP7","RBBP8","RING1","RNF2","RRM2","RYBP","SUZ12","TFDP1","TFDP2","UXT","YAF2")

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = g0_genes, name="G0_dormant_Fukushima")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),G0_dormant_Fukushima=range01(integrated.obj1$G0_dormant_Fukushima1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=G0_dormant_Fukushima,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 7. ER_stress ####
ER_stress <- list(c("EIF2AK3","DERL2","SELENOS","PARP16","BFAR","ATF6","TMEM33","NCK1","PTPN1","WFS1","COPS5","ATF6B","BAX","PIGBOS1","AGR2","ERN1","CDK5RAP3","AMFR","VAPB","XBP1","PIK3R1","BAK1","TBL2","YOD1","FICD","DERL3","DERL1","CREB3","NUPR1","SESN2","SCAMP5","PRKN","OS9","EIF2AK3","GORASP2","UBA5","EIF2B5","RASGRF2","EIF2S1","TRIB3","DDIT3","DNAJC10","ATF4","TMEM33","ERP44","TNFRSF10B","MANF","USP19","TMTC3","HYOU1","PTPN1","UFL1","UFM1","WFS1","CFTR","ATP2A1","BCL2L11","ERN1","CXCL8","CREB3L2","VAPB","UFC1","FLOT1","RNF183","PPP1R15A","TMX1","P4HB","FICD","UBQLN1","RASGRF1","SEC16A","MAP3K5","CEBPB"))

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = ER_stress, name="ER_stress")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),ER_stress=range01(integrated.obj1$ER_stress1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=ER_stress,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 8. ROS (GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS) ####
GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS <- list(c("AATF","ABCD1","ABCD2","ACE2","ACOD1","ACP5","ADGRB1","AGT","AGTR1","AGTR2","AGXT2","AIF1","AKR1C3","AKT1","ALOX12","ALOX5","APOA4","ARF4","ARG2","ASS1","ATG5","ATP2B4","ATP5IF1","ATP7A","BCL2","BCO2","BCR","BIRC2","BMP7","BNIP3","BRCA1","BST1","CAT","CAV1","CCN1","CCN2","CCN6","CCS","CD177","CD34","CD36","CD47","CDKN1A","CFLAR","CLEC7A","CLU","COA8","COQ7","CPS1","CRP","CRYAB","CTNS","CX3CR1","CYB5R4","CYBA","CYBB","CYP1A1","CYP1A2","CYP1B1","DDAH1","DDAH2","DDIT4","DHFR","DHFRP1","DNM2","DRD5","DUOX1","DUOX2","DUOXA1","DUOXA2","EDN1","EGFR","EIF6","EPX","F2","F2RL1","FANCC","FBLN5","FOXM1","FOXO1","FOXO3","FPR2","FYN","G6PD","GADD45A","GBF1","GCH1","GCHFR","GLA","GLS2","GNAI2","GNAI3","GPX1","GPX3","GRB2","GRIN1","GSTP1","HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ","HDAC4","HDAC6","HIF1A","HK2","HP","HSP90AA1","HSP90AB1","HSPD1","ICAM1","IFI6","IFNG","IL10","IL1B","IMMP2L","INAVA","INS","INSR","ITGAM","ITGB2","JAK2","KHSRP","KLF2","KLF4","KLRC4-KLRK1","KLRK1","LEP","LPO","LRRK2","MAOB","MAPK14","MAPT","MIR132","MIR181A1","MIR181A2","MIR181B1","MIR181B2","MIR199A1","MIR199A2","MIR21","MIR212","MIR24-1","MIR24-2","MIR27B","MIR590","MIR92A1","MIR92A2","MIR99B","MMP3","MMP8","MPO","MPV17","MPV17L","MT-CO2","MT-ND2","MT3","MTCO2P12","MTOR","NCF1","NCF1B","NCF1C","NCF2","NCF4","NDUFA13","NDUFAF2","NDUFS1","NDUFS3","NDUFS4","NFE2L2","NNT","NOS1","NOS1AP","NOS2","NOS3","NOX1","NOX3","NOX4","NOX5","NOXA1","NOXO1","NQO1","NQO2","NRROS","P2RX4","P2RX7","PAGE4","PARK7","PARL","PAX2","PDGFB","PDGFRB","PDK3","PDK4","PID1","PINK1","PKD2","PLA2R1","PLIN5","PMAIP1","PON3","POR","PRCP","PRDX1","PRDX2","PRDX3","PRDX4","PRDX5","PRDX6","PREX1","PRG3","PRKCD","PRKN","PTGIS","PTGS2","PTK2B","PTX3","PXDN","PXDNL","RAB27A","RAC1","RAC2","RFK","RGN","RHOA","RIPK1","RIPK3","RNF41","ROCK2","ROMO1","RORA","SELENOS","SESN1","SESN2","SFTPD","SH3PXD2A","SH3PXD2B","SIRPA","SIRT2","SIRT3","SIRT5","SLC18A2","SLC25A33","SLC30A10","SLC5A3","SLC7A2","SMAD3","SNCA","SOD1","SOD2","SOD3","SPHK2","SPR","STAT3","STK17A","SYK","SZT2","TAFA4","TFAP2A","TGFB1","TGFBR2","THBS1","TICAM1","TIGAR","TLR2","TLR4","TLR6","TMEM106A","TNF","TP53","TPO","TRAP1","TRPV1","TSPO","TUSC2","TYROBP","UCP1","VAV1","VDAC1","WDR35","XDH","ZC3H12A","ZNF205"))

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS, name="GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS=range01(integrated.obj1$GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 


#### 9. Try with other LSC signatures: Gentles up regulated genes on LSC samples ####
Gentles <- list(c("EFCC1","FCMR","GIMAP2","GIMAP7","LGALSL","LOC727893","MMRN1","SLC38A1","VNN1","BIRC3","CD34","EBF3","EVI2A","GIMAP6","GUCY1A1","HOPX","ICAM1","PCDHGC3","GSAP","RBPMS","SETBP1","SH3BP5","ABCC2","FBXO21","HECA","HLF","LOC100128550","LTB","MEF2C","SLC37A3","TMEM200A"))
names(Gentles) <- "Gentles"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Gentles, name="Gentles")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Gentles=range01(integrated.obj1$Gentles1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Gentles,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 

#### 10. Try with other LSC signatures: Eppert up regulated genes on LSC samples ####
Eppert <- list(c("NIPAL2","RBPMS","TRAF3IP2","PPP1R10","ATP1B1","NF1","RBPMS","KLF3-AS1","RBPMS","ABCG1","CLN5","LRRC8B","FRMD4B","ZFP30","SNHG20","CDIP1","TGIF2","RABGAP1","PPIG","ADGRG1","EIF2S3","NAB1","LRRC61","ATP1B1","ZNF500","CSDE1","C2CD2","PAQR6","EEF1AKMT3","ARPP19","SETDB1","ZBTB39","RBPMS","SLC9A7","MAP3K7","ARL3","ZNF304","LOC552889","VGLL4","UBR5","PTCD2","CDK12","IQGAP2","PLCH1","ARFGEF1","MAP3K7","PNPLA4"))
names(Eppert) <- "Eppert"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Eppert, name="Eppert")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Eppert=range01(integrated.obj1$Eppert1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Eppert,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 


#### 11. Try with other LSC signatures: Ishikawa up regulated genes on LSC samples ####
Ishikawa <- list(c("WT1","SUCNR1","PDE9A","HCK","AK5","DOK2","LRG1","BIK","CTSC","FCGR2A","ITGB2","CD93","ADGRE5","CD33","IL2RG","LY86","TNFRSF4","TNFSF13B","IL2RA","IL7R","CD1C","CD86","CD24","CEACAM6","CD180"))
names(Ishikawa) <- "Ishikawa"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Ishikawa, name="Ishikawa")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Ishikawa=range01(integrated.obj1$Ishikawa1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML8_Dx_3" | aux_df1$old_clustering=="AML8_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Ishikawa,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 

```


## 2. AML9_Dx-AML9_Rx: Take the LSC clusters we derived independently

```{r part2, echo=FALSE, fig.height=8, fig.width=4, message=FALSE}
library(Seurat) 
library(ggplot2) 
library(ggExtra) 
library(dplyr)
library(data.table)
library(grid)
library(RColorBrewer)
library(forcats) 

Hypoxia_genes <- list(c("ABCB1","ABCG2","ADM","ADRA1B","AK4","ALDOA","ALDOC","ANGPT2","ANKRD37","ANXA1","BHLHE40","BHLHE41","BNIP3","BNIP3L","CA9","CAD","CALCRL","CAPG","CCNG2","CCR7","CD99","CDKN1A","CITED2","COL5A1","CP","CTGF","CTSD","CXCL12","CXCR4","CYP2S1","DDIT4","DEC1","EDN1","EGLN1","EGLN3","ENG","ENO1","EPO","ERO1A","ETS1","FAM162A","FECH","FN1","FURIN","GADD45B","GAPDH","GPI","GPX3","HK1","HK2","HMOX1","HSP90B1","ID2","IGF2","IGFBP1","IGFBP2","IGFBP3","ITGB2","JUNB","KDM3A","KDM4B","KITLG","KRT14","KRT18","KRT19","LDHA","LEP","LGALS1","LOX","LRP1","MCL1","MET","MMP14","MMP2","MMP9","MXI1","NAMPT","NOS2","NOS3","NPM1","NR4A1","NRN1","NT5E","P4HA1","P4HA2","P4HTM","PDGFA","PDK1","PFKFB3","PFKL","PGK1","PKM","PLAUR","PMAIP1","PPP5C","PROK1","RCOR2","S100A4","SENP1","SERPINE1","SLC2A1","SLC2A3","SOX9","STC2","TCF3","TERT","TF","TFF3","TFRC","TGFA","TGFB3","TGM2","TPI1","TWIST1","UCN2","VEGFA","VIM","ZEB1","ZEB2"))

Other_LSC_markers <- list(c("CD93","MIR126","IL3RA","HAVCR2","CD96","CLEC12A","IL2RA","FCGR2A","CD47","HLF","CD33","CD52","CD82","CD99","IL1RAP","CD36","ADGRG1","BCL2","CD200","KLRK1"))

LSC_signature <- list(c("DNMT3B","CD34","ADGRG1","SOCS2","SPINK2","FAM30A"))

#### 1. Load samples processed from AML9_Dx.Rmd and AML9_Rx.Rmd
AML9_Dx$orig.name <- "AML9_Dx"
AML9_Dx$old_clustering <- paste0("AML9_Dx_",Idents(AML9_Dx))
AML9_Dx$Cond <- "Dx"

AML9_Rx$orig.name <- "AML9_Rx"
AML9_Rx$old_clustering <- paste0("AML9_Rx_",Idents(AML9_Rx))
AML9_Rx$Cond <- "Rx"

#### 2.  Integrate the datasets
dt.list <- unlist(list(c(AML9_Dx,AML9_Rx)))
for (i in 1:length(dt.list)) {
    dt.list[[i]] <- NormalizeData(dt.list[[i]], verbose = FALSE)
    dt.list[[i]] <- FindVariableFeatures(dt.list[[i]], selection.method = "vst", nfeatures = 2000, verbose = FALSE)
}
anchors <- FindIntegrationAnchors(object.list = dt.list, dims = 1:30)
integrated.obj1 <- IntegrateData(anchorset = anchors, dims = 1:30)

#### 3. PCA and markers
DefaultAssay(integrated.obj1) <- "integrated"
integrated.obj1 <- ScaleData(integrated.obj1,vars.to.regress = c("nCount_RNA","percent.mito"), features = rownames(integrated.obj1))
integrated.obj1 <- RunPCA(integrated.obj1, features = VariableFeatures(integrated.obj1), npcs = 40)
ElbowPlot(integrated.obj1,ndims = 40)

#Use first 20 PC
n_PC = 20
integrated.obj1 <- FindNeighbors(integrated.obj1, dims = 1:n_PC)

integrated.obj1 <- FindClusters(integrated.obj1, resolution = 0.5)
head(Idents(integrated.obj1), 5)

n_cells = ncol(integrated.obj1)
getPalette = colorRampPalette(brewer.pal(11, "Set1"))
colors = getPalette(length(unique(Idents(integrated.obj1))))

#UMAP
integrated.obj1 <- RunUMAP(integrated.obj1, dims = 1:n_PC)
# Plot
DimPlot(integrated.obj1, reduction = "umap",  pt.size = 1.2) + scale_color_manual(values = colors)
DimPlot(integrated.obj1, reduction = "umap", group.by = "Sample_id", pt.size = 1.2 ) 
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "Phase") 
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "orig.name") 
plot1 <- DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "Cond") + scale_color_manual(values =c("#82bbbf", "#fc03be")) + NoAxes()
plot1
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "old_clustering", label = TRUE) + NoLegend()
integrated.obj1$prediction <- factor(integrated.obj1$prediction,levels=c("HSC","Prog","GMP","ProMono","Mono","cDC","pDC","earlyEry","lateEry","ProB","B","Plasma","T","CTL","NK"))
getPalette = colorRampPalette(brewer.pal(12, "Paired"))
colors2 = getPalette(15)
plot2 <- DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "prediction", label = TRUE) +  scale_color_manual(values = colors2)
plot2
colorsVelten <- readRDS(file="~/predictions_Velten_colorpalette.rds")
integrated.obj1$celltype[which(integrated.obj1$celltype=="Lymphoid-primed")] <- "LMPPs"
integrated.obj1$celltype[which(integrated.obj1$celltype=="Mast")] <- "Eosinophil-basophil-mast prog"
plot3 <- DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "celltype", label = TRUE) +  scale_color_manual(values = colorsVelten)
plot3
#Color the LSC clusters from Dx/Rx
DimPlot(object = integrated.obj1, reduction = 'umap', pt.size = 1.2, group.by = "celltype", label = TRUE)

#Get all markers, without logFC filter
all_markers_LSC_AML9 <- FindMarkers(integrated.obj1, ident.1 = "AML9_Dx_2", ident.2 = "AML9_Rx_4", only.pos = FALSE, logfc.threshold = 0)
all_markers_LSC_AML9$cluster <- unlist(lapply(all_markers_LSC_AML9$avg_log2FC,function(x)ifelse(x>0,"AML9_Dx_2","AML9_Rx_4")))
all_markers_LSC_AML9$avg_log2FC <- abs(all_markers_LSC_AML9$avg_log2FC)
all_markers_LSC_AML9$gene <- rownames(all_markers_LSC_AML9)
table(all_markers_LSC_AML9[which(all_markers_LSC_AML9$avg_log2FC>=0.25),]$cluster)

```

### 2.1 Check the differences between Dx/Rx on the LSC6 and Hypoxia

```{r part2.1, echo=FALSE, fig.height=5, fig.width=5, message=FALSE}
library(ggpubr)

aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Elsayed_LSC_score_integrated=integrated.obj1$Elsayed_LSC_score_integrated,Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id,Hypoxia=range01(integrated.obj1$Hypoxia_genes1))
aux_df1$log.Elsayed_LSC_score_integrated <- log(range01(aux_df1$Elsayed_LSC_score_integrated)+0.01)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_2" | aux_df1$old_clustering=="AML9_Rx_4")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
aux_df1$LSC_status2 <- "Xx_LSC 34+"
aux_df1$LSC_status2[which(aux_df1$LSC_status=="LSC 34+" & aux_df1$Condition=="Dx")] <- "Dx_LSC 34+"
aux_df1$LSC_status2[which(aux_df1$LSC_status=="LSC 34+" & aux_df1$Condition=="Rx")] <- "Rx_LSC 34+"

plot2 <- ggplot(aux_df1,aes(x=LSC_status,y=log.Elsayed_LSC_score_integrated,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 
plot2
plot3 <- ggplot(aux_df1,aes(x=LSC_status,y=Hypoxia,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 
plot3
#Sort by LSC_status2
aux_df1 <- aux_df1[order(aux_df1$LSC_status2, decreasing=T),]
aux_df1$LSC_status2[which(aux_df1$LSC_status2=="Xx_LSC 34+")] <- NA

plot4 <- ggplot(aux_df1,aes(x=umap1,y=umap2,colour=LSC_status2)) +
  geom_point() +
  theme_void() +
  scale_color_manual(values=c("#5ECECF", "#3070D6"))
plot4

```

### 2.2 Test other signatures and the difference between Dx/Rx

```{r part2.2, echo=FALSE, fig.height=5, fig.width=6, message=FALSE}
library(ggpubr)
library(UCell)
library(xlsx)

#Scale all values from 0 to 1
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
DefaultAssay(integrated.obj1) <- "RNA"

#Create an extra variable to differentiate between the LSC groups on Dx/Rx
LSC_status <- rep("NonLSC 38+",ncol(integrated.obj1))
LSC_status[which(integrated.obj1$Sample_id=="CD34")] <- "NonLSC 34+"
LSC_status[which(integrated.obj1$old_clustering=="AML9_Dx_2" | integrated.obj1$old_clustering=="AML9_Rx_4")] <- "LSC 34+"
LSC_status <- factor(LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
names(LSC_status) <- colnames(integrated.obj1)
integrated.obj1 <- AddMetaData(object = integrated.obj1, metadata = LSC_status, col.name = "LSC_status")

#Get only the genes expressed comarping also against the rest of cells
Idents(integrated.obj1) <- paste0(integrated.obj1$LSC_status,"_",integrated.obj1$Cond)
integrated.obj1 <- AddMetaData(object = integrated.obj1, metadata = Idents(integrated.obj1), col.name = "Group2")
integrated.obj1$Group2 <- factor(integrated.obj1$Group2, levels=c("LSC 34+_Dx","LSC 34+_Rx","NonLSC 34+_Dx","NonLSC 34+_Rx","NonLSC 38+_Dx","NonLSC 38+_Rx"))

#### 1. Hallmark glycolisis (Msigdb) ####
hallmark_glycolisis <- list(c("ABCB6","ADORA2B","AGL","AGRN","AK3","AK4","AKR1A1","ALDH7A1","ALDH9A1","ALDOA","ALDOB","ALG1","ANG","ANGPTL4","ANKZF1","ARPP19","ARTN","AURKA","B3GALT6","B3GAT1","B3GAT3","B3GNT3","B4GALT1","B4GALT2","B4GALT4","B4GALT7","BIK","BPNT1","CACNA1H","CAPN5","CASP6","CD44","CDK1","CENPA","CHPF","CHPF2","CHST1","CHST12","CHST2","CHST4","CHST6","CITED2","CLDN3","CLDN9","CLN6","COG2","COL5A1","COPB2","CTH","CXCR4","CYB5A","DCN","DDIT4","DEPDC1","DLD","DPYSL4","DSC2","ECD","EFNA3","EGFR","EGLN3","ELF3","ENO1","ENO2","ERO1A","EXT1","EXT2","FAM162A","FBP2","FKBP4","FUT8","G6PD","GAL3ST1","GALE","GALK1","GALK2","GAPDHS","GCLC","GFPT1","GLCE","GLRX","GMPPA","GMPPB","GNE","GNPDA1","GOT1","GOT2","GPC1","GPC3","GPC4","GPR87","GUSB","GYS1","GYS2","HAX1","HDLBP","HK2","HMMR","HOMER1","HS2ST1","HS6ST2","HSPA5","IDH1","IDUA","IER3","IGFBP3","IL13RA1","IRS2","ISG20","KDELR3","KIF20A","KIF2A","LCT","LDHA","LDHC","LHPP","LHX9","MDH1","MDH2","ME1","ME2","MED24","MERTK","MET","MIF","MIOX","MPI","MXI1","NANP","NASP","NDST3","NDUFV3","NOL3","NSDHL","NT5E","P4HA1","P4HA2","PAM","PAXIP1","PC","PDK3","PFKFB1","PFKP","PGAM1","PGAM2","PGK1","PGLS","PGM2","PHKA2","PKM","PKP2","PLOD1","PLOD2","PMM2","POLR3K","PPFIA4","PPIA","PPP2CB","PRPS1","PSMC4","PYGB","PYGL","QSOX1","RARS1","RBCK1","RPE","RRAGD","SAP30","SDC1","SDC2","SDC3","SDHC","SLC16A3","SLC25A10","SLC25A13","SLC35A3","SLC37A4","SOD1","SOX9","SPAG4","SRD5A3","STC1","STC2","STMN1","TALDO1","TFF3","TGFA","TGFBI","TKTL1","TPBG","TPI1","TPST1","TSTA3","TXN","UGP2","VCAN","VEGFA","VLDLR","XYLT2","ZNF292"))
names(hallmark_glycolisis) <- "hallmark_glycolisis"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = hallmark_glycolisis, name="hallmark_glycolisis")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),hallmark_glycolisis=range01(integrated.obj1$hallmark_glycolisis1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=hallmark_glycolisis,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 2. Hallmark Ox phosphorilation (MsigDB) ####
hallmark_ox_phosphorylation <- list(c("ABCB7","ACAA1","ACAA2","ACADM","ACADSB","ACADVL","ACAT1","ACO2","AFG3L2","AIFM1","ALAS1","ALDH6A1","ATP1B1","ATP5F1A","ATP5F1B","ATP5F1C","ATP5F1D","ATP5F1E","ATP5MC1","ATP5MC2","ATP5MC3","ATP5ME","ATP5MF","ATP5MG","ATP5PB","ATP5PD","ATP5PF","ATP5PO","ATP6AP1","ATP6V0B","ATP6V0C","ATP6V0E1","ATP6V1C1","ATP6V1D","ATP6V1E1","ATP6V1F","ATP6V1G1","ATP6V1H","BAX","BCKDHA","BDH2","CASP7","COX10","COX11","COX15","COX17","COX4I1","COX5A","COX5B","COX6A1","COX6B1","COX6C","COX7A2","COX7A2L","COX7B","COX7C","COX8A","CPT1A","CS","CYB5A","CYB5R3","CYC1","CYCS","DECR1","DLAT","DLD","DLST","ECH1","ECHS1","ECI1","ETFA","ETFB","ETFDH","FDX1","FH","FXN","GLUD1","GOT2","GPI","GPX4","GRPEL1","HADHA","HADHB","HCCS","HSD17B10","HSPA9","HTRA2","IDH1","IDH2","IDH3A","IDH3B","IDH3G","IMMT","ISCA1","ISCU","LDHA","LDHB","LRPPRC","MAOB","MDH1","MDH2","MFN2","MGST3","MPC1","MRPL11","MRPL15","MRPL34","MRPL35","MRPS11","MRPS12","MRPS15","MRPS22","MRPS30","MTRF1","MTRR","MTX2","NDUFA1","NDUFA2","NDUFA3","NDUFA4","NDUFA5","NDUFA6","NDUFA7","NDUFA8","NDUFA9","NDUFAB1","NDUFB1","NDUFB2","NDUFB3","NDUFB4","NDUFB5","NDUFB6","NDUFB7","NDUFB8","NDUFC1","NDUFC2","NDUFS1","NDUFS2","NDUFS3","NDUFS4","NDUFS6","NDUFS7","NDUFS8","NDUFV1","NDUFV2","NNT","NQO2","OAT","OGDH","OPA1","OXA1L","PDHA1","PDHB","PDHX","PDK4","PDP1","PHB2","PHYH","PMPCA","POLR2F","POR","PRDX3","RETSAT","RHOT1","RHOT2","SDHA","SDHB","SDHC","SDHD","SLC25A11","SLC25A12","SLC25A20","SLC25A3","SLC25A4","SLC25A5","SLC25A6","SUCLA2","SUCLG1","SUPV3L1","SURF1","TCIRG1","TIMM10","TIMM13","TIMM17A","TIMM50","TIMM8B","TIMM9","TOMM22","TOMM70","UQCR10","UQCR11","UQCRB","UQCRC1","UQCRC2","UQCRFS1","UQCRH","UQCRQ","VDAC1","VDAC2","VDAC3"))
names(hallmark_ox_phosphorylation) <- "hallmark_ox_phosphorylation"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = hallmark_ox_phosphorylation, name="hallmark_ox_phosphorylation")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),hallmark_ox_phosphorylation=range01(integrated.obj1$hallmark_ox_phosphorylation1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=hallmark_ox_phosphorylation,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 3. lysosome ####
lysosome <- list(c("TCIRG1","ATP6V0A2","ATP6V0A4","ATP6V0A1","ATP6V0D1","ATP6V1H","ATP6AP1","ATP6V0C","ATP6V0B","CTSA","CTSB","CTSC","CTSD","CTSE","CTSF","CTSG","CTSH","CTSK","CTSL","CTSO","CTSS","CTSV","CTSW","CTSZ","NAPSA","LGMA","TPP1","GLA","GLB1","GAA","GBA","IDUA","NAGA","NAGLU","GALC","GUSB","FUCA1","FUCA2","HEXA","HEXB","MANBA","MAN2B1","NEU1","HYAL2","HYAL1","SPAM1","HYAL4","HYAL3","ARSA","ARSB","ARSG","GALNS","GNS","IDS","SGSH","LIPA","PLA2G15","DNASE2B","DNASE2","ACP2","ACO5","SMPD1","ASAH1","AGA","PSAP","PSAPL1","GM2A","PPT1","PPT2","LAMP1","LAMP2","LAMP3","CD68","CD63","SCARB2","NPC1","NPC2","CTNS","SLC17A5","SLC11A1","SLC11A2","LAPTM4B","LAPTM5","LAPTM4A","ABCA2","ABCB9","CD164","ENTPD4","SORT1","CLN3","CLN5","MFSD8","HGSNAT","SUMF1","GNPTAB","GNPTG","NAGPA","IGF2R","M6PR","CLT1","CLTB","CLTC","CLTCL1","AP1G1","AP1G2","AP1B1","AP1M1","AP1M2","AP1S1","AP1S2","AP1S3","AP3D1","AP3B2","AP3B1","AP3M1","AP3M2","AP3S2","AP3S1","AP4E1","AP4B1","AP4M1","AP4S1","GGA2","GGA3","GGA1","MCOLN1","LITAF"))
names(lysosome) <- "lysosome"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = lysosome, name="lysosome")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),lysosome=range01(integrated.obj1$lysosome1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=lysosome,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



####4. Negative_G0_to_G1  ####
Negative_G0_to_G1 <- list(c("RBBP7","DAB2IP","MGA","YAF2","RYBP","PHC3","L3MBTL2","EHMT2","RNF2","RBBP8","PCGF6","EPC1","EHMT1","UXT","DUX4","PPP2R5B","CDC7","APAF1","CHEK1","E2F6","EED","HLA-G","RRM2","BMI1","PCGF2","BRCA1","CBX5","MAX","PHC1","FOXO4","E2F1","RING1","RAD51","RBBP4","CBX3","TFDP1","TFDP2","SUZ12","PPP2R5B","EZH2"))
names(Negative_G0_to_G1) <- "Negative_G0_to_G1"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Negative_G0_to_G1, name="Negative_G0_to_G1")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Negative_G0_to_G1=range01(integrated.obj1$Negative_G0_to_G11),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Negative_G0_to_G1,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 5. Translation Initiation ####
translation <- list(c("ABCE1","AGO2","ALKBH1","ATF4","BANK1","BOLL","C8orf88","CCL5","CDC123","COPS5","CTIF","DAZ1","DAZ2","DAZ3","DAZ4","DAZL","DDX1","DDX3X","DENR","DHX29","DHX33","DNAJC3","EIF1","EIF1AD","EIF1AX","EIF1AY","EIF1B","EIF2A","EIF2AK1","EIF2AK2","EIF2AK3","EIF2AK4","EIF2B1","EIF2B2","EIF2B3","EIF2B4","EIF2B5","EIF2D","EIF2S1","EIF2S2","EIF2S3","EIF2S3B","EIF3A","EIF3B","EIF3C","EIF3CL","EIF3D","EIF3E","EIF3F","EIF3G","EIF3H","EIF3I","EIF3J","EIF3K","EIF3L","EIF3M","EIF4A1","EIF4A2","EIF4B","EIF4E","EIF4E1B","EIF4E2","EIF4E3","EIF4EBP1","EIF4EBP2","EIF4EBP3","EIF4G1","EIF4G2","EIF4G3","EIF4H","EIF5","EIF5B","EIF6","FMR1","GLE1","HABP4","HSPB1","IMPACT","KHDRBS1","KLHL25","LARP1","LTO1","MCTS1","METTL3","MIF4GD","MTFMT","MTIF2","MTIF3","MTOR","NCBP1","NCBP2","NCK1","NCK2","NPM1","PABPC1","PAIP1","PAIP2","PAIP2B","POLR2D","POLR2G","PPP1CA","PPP1R15A","PPP1R15B","RBM4","RPL10","RPL10A","RPL11","RPL12","RPL13","RPL13A","RPL14","RPL15","RPL17","RPL18","RPL18A","RPL19","RPL21","RPL22","RPL23","RPL23A","RPL24","RPL26","RPL27","RPL27A","RPL28","RPL29","RPL3","RPL30","RPL31","RPL32","RPL34","RPL35","RPL35A","RPL36","RPL36A","RPL37","RPL37A","RPL38","RPL39","RPL4","RPL41","RPL5","RPL6","RPL7","RPL7A","RPL8","RPL9","RPLP0","RPLP1","RPLP2","RPS10","RPS11","RPS12","RPS13","RPS14","RPS15","RPS15A","RPS16","RPS17","RPS18","RPS19","RPS2","RPS20","RPS21","RPS23","RPS24","RPS25","RPS26","RPS27","RPS27A","RPS28","RPS29","RPS3","RPS3A","RPS4X","RPS4Y1","RPS5","RPS6","RPS6KB1","RPS6KB2","RPS7","RPS8","RPS9","RPSA","RXRA","TNF","TPR","UBA52","UHMK1","YTHDF1","YTHDF2","YTHDF3"))
names(translation) <- "translation"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = translation, name="translation")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),translation=range01(integrated.obj1$translation1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=translation,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 6. G0_Fukushima ####
go_genes <- c("APAF1","BMI1","BRCA1","CBX3","CBX5","CDC7","CHEK1","DAB2IP","DUX4","E2F1","E2F6","EED","EHMT1","EHMT2","EPC1","EZH2","FOXO4","HLA-G","L3MBTL2","MAX","MGA","PCGF2","PCGF6","PHC1","PHC3","PPP2R5B","PPP2R5B","RAD51","RBBP4","RBBP7","RBBP8","RING1","RNF2","RRM2","RYBP","SUZ12","TFDP1","TFDP2","UXT","YAF2")

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = g0_genes, name="G0_dormant_Fukushima")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),G0_dormant_Fukushima=range01(integrated.obj1$G0_dormant_Fukushima1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=G0_dormant_Fukushima,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 7. ER_stress ####
ER_stress <- list(c("EIF2AK3","DERL2","SELENOS","PARP16","BFAR","ATF6","TMEM33","NCK1","PTPN1","WFS1","COPS5","ATF6B","BAX","PIGBOS1","AGR2","ERN1","CDK5RAP3","AMFR","VAPB","XBP1","PIK3R1","BAK1","TBL2","YOD1","FICD","DERL3","DERL1","CREB3","NUPR1","SESN2","SCAMP5","PRKN","OS9","EIF2AK3","GORASP2","UBA5","EIF2B5","RASGRF2","EIF2S1","TRIB3","DDIT3","DNAJC10","ATF4","TMEM33","ERP44","TNFRSF10B","MANF","USP19","TMTC3","HYOU1","PTPN1","UFL1","UFM1","WFS1","CFTR","ATP2A1","BCL2L11","ERN1","CXCL8","CREB3L2","VAPB","UFC1","FLOT1","RNF183","PPP1R15A","TMX1","P4HB","FICD","UBQLN1","RASGRF1","SEC16A","MAP3K5","CEBPB"))

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = ER_stress, name="ER_stress")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),ER_stress=range01(integrated.obj1$ER_stress1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=ER_stress,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 



#### 8. ROS (GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS) ####
GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS <- list(c("AATF","ABCD1","ABCD2","ACE2","ACOD1","ACP5","ADGRB1","AGT","AGTR1","AGTR2","AGXT2","AIF1","AKR1C3","AKT1","ALOX12","ALOX5","APOA4","ARF4","ARG2","ASS1","ATG5","ATP2B4","ATP5IF1","ATP7A","BCL2","BCO2","BCR","BIRC2","BMP7","BNIP3","BRCA1","BST1","CAT","CAV1","CCN1","CCN2","CCN6","CCS","CD177","CD34","CD36","CD47","CDKN1A","CFLAR","CLEC7A","CLU","COA8","COQ7","CPS1","CRP","CRYAB","CTNS","CX3CR1","CYB5R4","CYBA","CYBB","CYP1A1","CYP1A2","CYP1B1","DDAH1","DDAH2","DDIT4","DHFR","DHFRP1","DNM2","DRD5","DUOX1","DUOX2","DUOXA1","DUOXA2","EDN1","EGFR","EIF6","EPX","F2","F2RL1","FANCC","FBLN5","FOXM1","FOXO1","FOXO3","FPR2","FYN","G6PD","GADD45A","GBF1","GCH1","GCHFR","GLA","GLS2","GNAI2","GNAI3","GPX1","GPX3","GRB2","GRIN1","GSTP1","HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ","HDAC4","HDAC6","HIF1A","HK2","HP","HSP90AA1","HSP90AB1","HSPD1","ICAM1","IFI6","IFNG","IL10","IL1B","IMMP2L","INAVA","INS","INSR","ITGAM","ITGB2","JAK2","KHSRP","KLF2","KLF4","KLRC4-KLRK1","KLRK1","LEP","LPO","LRRK2","MAOB","MAPK14","MAPT","MIR132","MIR181A1","MIR181A2","MIR181B1","MIR181B2","MIR199A1","MIR199A2","MIR21","MIR212","MIR24-1","MIR24-2","MIR27B","MIR590","MIR92A1","MIR92A2","MIR99B","MMP3","MMP8","MPO","MPV17","MPV17L","MT-CO2","MT-ND2","MT3","MTCO2P12","MTOR","NCF1","NCF1B","NCF1C","NCF2","NCF4","NDUFA13","NDUFAF2","NDUFS1","NDUFS3","NDUFS4","NFE2L2","NNT","NOS1","NOS1AP","NOS2","NOS3","NOX1","NOX3","NOX4","NOX5","NOXA1","NOXO1","NQO1","NQO2","NRROS","P2RX4","P2RX7","PAGE4","PARK7","PARL","PAX2","PDGFB","PDGFRB","PDK3","PDK4","PID1","PINK1","PKD2","PLA2R1","PLIN5","PMAIP1","PON3","POR","PRCP","PRDX1","PRDX2","PRDX3","PRDX4","PRDX5","PRDX6","PREX1","PRG3","PRKCD","PRKN","PTGIS","PTGS2","PTK2B","PTX3","PXDN","PXDNL","RAB27A","RAC1","RAC2","RFK","RGN","RHOA","RIPK1","RIPK3","RNF41","ROCK2","ROMO1","RORA","SELENOS","SESN1","SESN2","SFTPD","SH3PXD2A","SH3PXD2B","SIRPA","SIRT2","SIRT3","SIRT5","SLC18A2","SLC25A33","SLC30A10","SLC5A3","SLC7A2","SMAD3","SNCA","SOD1","SOD2","SOD3","SPHK2","SPR","STAT3","STK17A","SYK","SZT2","TAFA4","TFAP2A","TGFB1","TGFBR2","THBS1","TICAM1","TIGAR","TLR2","TLR4","TLR6","TMEM106A","TNF","TP53","TPO","TRAP1","TRPV1","TSPO","TUSC2","TYROBP","UCP1","VAV1","VDAC1","WDR35","XDH","ZC3H12A","ZNF205"))

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS, name="GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS=range01(integrated.obj1$GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 


#### 9. Try with other LSC signatures: Gentles up regulated genes on LSC samples ####
Gentles <- list(c("EFCC1","FCMR","GIMAP2","GIMAP7","LGALSL","LOC727893","MMRN1","SLC38A1","VNN1","BIRC3","CD34","EBF3","EVI2A","GIMAP6","GUCY1A1","HOPX","ICAM1","PCDHGC3","GSAP","RBPMS","SETBP1","SH3BP5","ABCC2","FBXO21","HECA","HLF","LOC100128550","LTB","MEF2C","SLC37A3","TMEM200A"))
names(Gentles) <- "Gentles"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Gentles, name="Gentles")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Gentles=range01(integrated.obj1$Gentles1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Gentles,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 

#### 10. Try with other LSC signatures: Eppert up regulated genes on LSC samples ####
Eppert <- list(c("NIPAL2","RBPMS","TRAF3IP2","PPP1R10","ATP1B1","NF1","RBPMS","KLF3-AS1","RBPMS","ABCG1","CLN5","LRRC8B","FRMD4B","ZFP30","SNHG20","CDIP1","TGIF2","RABGAP1","PPIG","ADGRG1","EIF2S3","NAB1","LRRC61","ATP1B1","ZNF500","CSDE1","C2CD2","PAQR6","EEF1AKMT3","ARPP19","SETDB1","ZBTB39","RBPMS","SLC9A7","MAP3K7","ARL3","ZNF304","LOC552889","VGLL4","UBR5","PTCD2","CDK12","IQGAP2","PLCH1","ARFGEF1","MAP3K7","PNPLA4"))
names(Eppert) <- "Eppert"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Eppert, name="Eppert")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Eppert=range01(integrated.obj1$Eppert1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Eppert,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 


#### 11. Try with other LSC signatures: Ishikawa up regulated genes on LSC samples ####
Ishikawa <- list(c("WT1","SUCNR1","PDE9A","HCK","AK5","DOK2","LRG1","BIK","CTSC","FCGR2A","ITGB2","CD93","ADGRE5","CD33","IL2RG","LY86","TNFRSF4","TNFSF13B","IL2RA","IL7R","CD1C","CD86","CD24","CEACAM6","CD180"))
names(Ishikawa) <- "Ishikawa"

integrated.obj1 <- AddModuleScore(object = integrated.obj1, features = Ishikawa, name="Ishikawa")
aux_df1 <- data.frame(umap1=integrated.obj1$umap1,umap2=integrated.obj1$umap2,orig.name=integrated.obj1$orig.name,old_clustering=integrated.obj1$old_clustering,new_clustering=Idents(integrated.obj1),Ishikawa=range01(integrated.obj1$Ishikawa1),Condition=integrated.obj1$Cond,Sorting=integrated.obj1$Sample_id)
aux_df1$LSC_status <- "NonLSC 38+"
aux_df1$LSC_status[which(aux_df1$Sorting=="CD34")] <- "NonLSC 34+"
aux_df1$LSC_status[which(aux_df1$old_clustering=="AML9_Dx_3" | aux_df1$old_clustering=="AML9_Rx_8")] <- "LSC 34+"
aux_df1$LSC_status <- factor(aux_df1$LSC_status, levels=c("LSC 34+","NonLSC 34+","NonLSC 38+"))
ggplot(aux_df1,aes(x=LSC_status,y=Ishikawa,fill=Condition)) +
  geom_boxplot() +
  theme_classic() +
  scale_fill_manual(values=c("#82bbbf", "#fc03be")) +
    theme(text = element_text(size=24),
        axis.text.x = element_text(angle=90, hjust=1, vjust=0.5)) 

```


## 3. Compare the markers from both pair of samples

```{r part3, echo=FALSE, fig.height=8, fig.width=8, message=FALSE}
library(ggrepel)
library("biomaRt")
library("org.Hs.eg.db")
library(xlsx)
library(dplyr)

#### 1. Compare all markers obtained from the analysis of both pairs of Dx/Rx
nrow(all_markers_LSC_AML8)
nrow(all_markers_LSC_AML9)
#Label which genes are up on Dx/Rx
all_markers_LSC_AML8$cluster2 <- "Dx"
all_markers_LSC_AML8$cluster2[which(all_markers_LSC_AML8$cluster!="AML8_Dx_3")] <- "Rx"
table(all_markers_LSC_AML8$cluster2)
all_markers_LSC_AML9$cluster2 <- "Dx"
all_markers_LSC_AML9$cluster2[which(all_markers_LSC_AML9$cluster!="AML9_Dx_2")] <- "Rx"
table(all_markers_LSC_AML9$cluster2)

#Plot a VennDiagram
library(VennDiagram)
display_venn <- function(x, ...){
  library(VennDiagram)
  grid.newpage()
  venn_object <- venn.diagram(x, filename = NULL, ...)
  grid.draw(venn_object)
}

x <- list(
  AML8_Dx_Rx = all_markers_LSC_AML8$gene, 
  AML9_Dx_Rx = all_markers_LSC_AML9$gene
  )

display_venn(
  x,
  category.names = c("\t\tAML8_Dx_Rx" , "AML9_Dx_Rx\t\t\t\n\n"),
  fill = c("#56B4E9", "#E69F00"),
  cex = 2.,
  cat.cex = 2.5
  )

#Do a deregulogram
all_markers_LSC_AML8$log2FC <- all_markers_LSC_AML8$avg_log2FC
all_markers_LSC_AML8$log2FC[which(all_markers_LSC_AML8$cluster=="AML8_Dx_3")] <- -all_markers_LSC_AML8$log2FC[which(all_markers_LSC_AML8$cluster=="AML8_Dx_3")]
all_markers_LSC_AML9$log2FC <- all_markers_LSC_AML9$avg_log2FC
all_markers_LSC_AML9$log2FC[which(all_markers_LSC_AML9$cluster=="AML9_Dx_2")] <- -all_markers_LSC_AML9$log2FC[which(all_markers_LSC_AML9$cluster=="AML9_Dx_2")]
merge <- merge(all_markers_LSC_AML8,all_markers_LSC_AML9,by.x="gene",by.y="gene")
same_direction <- merge %>% filter((log2FC.x > 0.25 & log2FC.y > 0.25) | (log2FC.x < -0.25 & log2FC.y < -0.25))
oppo_direction <- merge %>% filter((log2FC.x > 0.25 & log2FC.y < -0.25) | (log2FC.x < -0.25 & log2FC.y > 0.25))
same_direction_text <- merge %>% filter((log2FC.x > 0.25 & log2FC.y > 0.25) | (log2FC.x < -0.5 & log2FC.y < -0.5))
merge$gene[which(!merge$gene%in%same_direction_text$gene)] <- ""
deregulogram_plot <- ggplot(merge,aes(label=gene,x=log2FC.x,y=log2FC.y)) +
  geom_point(size=1, alpha=0.5) +
  geom_point(data=same_direction, color="blue") +
  geom_point(data=oppo_direction, color="red") +
  geom_hline(yintercept=0.25,linetype="dashed") +
  geom_hline(yintercept=-0.25,linetype="dashed") +
  geom_vline(xintercept=0.25,linetype="dashed") +
  geom_vline(xintercept=-0.25,linetype="dashed") +
  xlab("log2FC(AML8_Rx - AML8_Dx)") +
  ylab("log2FC(AML9_Rx - AML9_Dx)") + 
  geom_text_repel(min.segment.length = 0, seed = 42, box.padding = 0.5, max.overlaps = 50) +
  theme(legend.title = element_blank()) +
  theme_bw()
